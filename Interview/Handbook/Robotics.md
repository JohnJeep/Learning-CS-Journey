<!--
 * @Author: JohnJeep
 * @Date: 2025-11-11 09:21:18
 * @LastEditors: JohnJeep
 * @LastEditTime: 2025-11-20 10:34:59
 * @Description: 机器人面试
 * Copyright (c) 2025 by John Jeep, All Rights Reserved. 
-->

- [1. 项目](#1-项目)
- [2. ROS底层DDS是怎样实现的？](#2-ros底层dds是怎样实现的)
- [3. 有没有遇见，传输数据时，DDS延迟或吞吐量达不到要求的情况？具体场景传什么数据？测下来延迟有多少？](#3-有没有遇见传输数据时dds延迟或吞吐量达不到要求的情况具体场景传什么数据测下来延迟有多少)
- [4. ROS 通信库本身有什么问题？](#4-ros-通信库本身有什么问题)
- [5. DDS 有一个基于本地间通信的共享内存，有用过吗？是怎么配置的？](#5-dds-有一个基于本地间通信的共享内存有用过吗是怎么配置的)
- [6. 你用 Topic 发出来的数据，你是怎么减少序列化与反序列化的？](#6-你用-topic-发出来的数据你是怎么减少序列化与反序列化的)
- [7. topic 中有没遇见数据传输量很大的数据，是什么样的数据？](#7-topic-中有没遇见数据传输量很大的数据是什么样的数据)
  - [7.1. 1.视觉检测系统数据，2D图像和3D点云。](#71-1视觉检测系统数据2d图像和3d点云)
  - [7.2. 2.焊接过程工艺参数数据。](#72-2焊接过程工艺参数数据)
    - [7.2.1. 焊机实时参数](#721-焊机实时参数)
  - [7.3. 热过程监控数据](#73-热过程监控数据)
  - [7.4. 3.机器人运动数据](#74-3机器人运动数据)
    - [7.4.1. 	六轴机器人运动实时数据](#741-六轴机器人运动实时数据)
    - [7.4.2. 力控焊接数据](#742-力控焊接数据)
  - [7.5. 协同控制网络数据](#75-协同控制网络数据)
    - [7.5.1. 实时位置同步数据](#751-实时位置同步数据)
    - [7.5.2. 安全系统数据](#752-安全系统数据)
  - [7.6. 实际数据流量统计](#76-实际数据流量统计)
  - [7.7. 应对策略](#77-应对策略)
- [8. 应用层注册一个回调函数，从发布到订阅，再触发回调，处理业务，整个流程ROS2 库底层是怎样实现的？](#8-应用层注册一个回调函数从发布到订阅再触发回调处理业务整个流程ros2-库底层是怎样实现的)
- [9. service 底层是怎么调用的？](#9-service-底层是怎么调用的)


### 1. 项目

1. 项目是做什么的？

   > 把机器人相关项目有条理、逻辑清楚的讲解给面试官听。

   汽车焊接生产产线上的六轴机器人。

2. 主要负责的内容是哪些部分？担任的角色是什么？

3. 用了哪些技术？具体怎么做的？



### 2. ROS底层DDS是怎样实现的？



### 3. 有没有遇见，传输数据时，DDS延迟或吞吐量达不到要求的情况？具体场景传什么数据？测下来延迟有多少？

DDS的延迟和吞吐量瓶颈通常源于以下几个原因：

1. **不当的QoS配置**：这是最常见的原因。例如，对高频传感器数据使用 `RELIABLE` 模式，会带来巨大的确认开销。
2. **序列化/反序列化开销**：将ROS2消息结构转换为DDS可传输的字节流（和反向转换）需要CPU时间。消息结构越复杂，开销越大。
3. 底层传输选择：DDS未能正确选择最高效的传输方式（例如，本该用共享内存却走了UDP环路）。
4. 网络状况：网络拥堵、高丢包率会触发重传机制，显著增加延迟。
5. DDS实现本身的开销：不同的DDS供应商在实现细节上（如线程模型、内存管理）有差异，可能导致性能瓶颈。

 

### 4. ROS 通信库本身有什么问题？

> 在实际开发中遇到了性能或稳定性问题。

1. **默认的 QoS 配置不是最优的。**

   ROS 2 为不同通信模式（如话题、服务、动作）提供了默认的 QoS 配置。

2. **序列化/反序列化机制（CDR:Common Data Representation）增加 CPU的开销。**

   **减少序列化的措施：**

   1. 启用零拷贝传输(Zero-Copy Transports)，进程之间用共享内存，绕过序列化/反序列化过程。

   1. 进程内(Intra-Process)通信。同一个进程中，使用 `rclcpp::NodeOptions` 来启用 `intra-process communication`。

      当发布者和订阅者在同一个进程中时，ROS 2可以绕过DDS的序列化、网络传输和反序列化整个流程，直接在内存中传递消息对象的指针。


3. **多进程通信延迟。**

   在同一台机器上，环境变量`ROS_LOCALHOST_ONLY = 1`时，ROS 2 节点默认使用**环回网络接口(localhost)**进行通信，与跨主机的网络通信一致，会引入额外的网络开销，导致进程间通信有延迟。可通过共享内存(share memory)传输解决。

4. DDS 本身（Fast DDS）运行时可能占用较多的内存和 CPU 资源，尤其是在创建大量主题和参与者时，在资源受限的嵌入式系统是一个挑战。

5. **节点发现问题。**

   DDS 使用基于 UDP 的发现协议来自动发现网络中的其他节点。在某些网络配置下（如多网卡、防火墙规则严格、VPN 环境），发现过程可能会失败或延迟很高，导致节点无法正常建立连接。

6. 接口易用性。ROS 2 的通信接口为了兼容 DDS 做出了一些牺牲。
   1. 服务调用必须指定超时。在 ROS 1 中，服务调用可以无限期等待。而在 ROS 2 中，由于底层 DDS      的限制，每个服务调用都必须设置一个明确的超时时间，这增加了代码的复杂性。
   2. “历史深度(history depth)”概念：DDS      引入了“历史深度”的概念来管理队列缓存。配置不当可能导致数据丢失（对于“KEEP_LAST”策略）或内存耗尽（对于“KEEP_ALL”策略）。



### 5. DDS 有一个基于本地间通信的共享内存，有用过吗？是怎么配置的？

1. 配置环境变量，选择为合适的DDS
2. 新建一个 XML 文件，指定 XML 文件和路径，编写共享内存的标签。



### 6. 你用 Topic 发出来的数据，你是怎么减少序列化与反序列化的？

1. 零拷贝传输(Zero-Copy Transports)
2. 采用进程内的通信。



### 7. topic 中有没遇见数据传输量很大的数据，是什么样的数据？

**案例：汽车焊接生产线**

- 6台机器人协同作业
- 每台机器人：关节数据 + 焊接参数 + 视觉检测
- 总数据流量：50-200 MB/s
- 要求：确定性延迟 < 2ms



汽车焊接生产线中，有 3 类数据量大的数据。

#### 7.1. 1.视觉检测系统数据，2D图像和3D点云。

**焊缝跟踪视觉数据**

- **数据源**：激光视觉传感器
- **数据类型**：3D轮廓点云
- **数据特征**：
  - 分辨率：1024×768 点云/帧
  - 帧率：30-60 fps（实时跟踪）
  - 单帧大小：2-5 MB
  - **实时数据流**：60-300 MB/s
- **用途**：实时焊缝位置识别、轨迹修正

#### 7.2. 2.焊接过程工艺参数数据。

##### 7.2.1. 焊机实时参数

每个焊点的工艺数据

```ini
- 焊接电流波形（10kHz采样）
- 焊接电压波形（10kHz采样）  
- 送丝速度（100Hz）
- 气体流量
- 电弧特性参数
```

- **单焊点数据**：0.5-1 MB
- **单车焊点数量**：3000-6000个
- **单车焊接数据总量**：**1.5-6 GB**



#### 7.3. 热过程监控数据

- 红外热像仪数据（焊接区域）
- 温度场分布（100Hz）
- 数据量：5-10 MB/s 每监控点



#### 7.4. 3.机器人运动数据

##### 7.4.1. 	六轴机器人运动实时数据

```ini
- 6个关节的编码器位置（1kHz采样）
- 6个关节的电机电流/扭矩（1kHz采样）
- 末端执行器位姿（500Hz）
- 振动加速度数据（2kHz，3轴）
- 伺服驱动状态参数
```

- **单机器人数据量**：**3-8 MB/s**
- **产线规模**：20-50台焊接机器人。
- **总运动数据**：**60-400 MB/s**



##### 7.4.2. 力控焊接数据

- 实时接触力反馈（500Hz）
- 压力分布数据
- 数据量：1-2 MB/s 每焊枪



#### 7.5. 协同控制网络数据

##### 7.5.1. 实时位置同步数据

- 多机器人协同轨迹数据
- 夹具与机器人同步信号
- 数据量：2-5 MB/s

##### 7.5.2. 安全系统数据

- 3D安全扫描仪点云
- 急停网络状态
- 区域访问控制数据
- 数据量：10-20 MB/s

#### 7.6. 实际数据流量统计

**典型汽车焊接产线总数据量**：

| 数据类别   | 实时数据流量     | 日数据总量     |
| :--------- | :--------------- | :------------- |
| 视觉系统   | 80-200 MB/s      | 2-5 TB         |
| 机器人运动 | 60-400 MB/s      | 1.5-10 TB      |
| 焊接工艺   | 20-100 MB/s      | 0.5-2.5 TB     |
| 质量控制   | 30-80 MB/s       | 0.8-2 TB       |
| **总计**   | **190-780 MB/s** | **5-20 TB/天** |

#### 7.7. 应对策略

1. 选择合适的QoS 策略。
2. 用共享内存和进程内通信替代默认的网络传输方式。
3. 特征提取：只传输处理后的结果（如视觉系统在本地检测焊缝位置，只传输焊缝的坐标和姿态，而不是整张图像。），而不是原始数据。
4. 数据分级处理
   1. 实时层（<10ms延迟）：少数据量，低延迟。比如：控制指令、安全信号。
   2. 过程层（<100ms延迟）：中等数据量。焊接参数调整、质量判定结果。
   3. 分析层：大数据量，可缓冲。历史数据、日志数据、传感器原始数据、工艺分析数据。
5. 降低采集评率。
6. 多网段隔离（控制网、数据网、管理网）



---

此部分为可选项：

1. **图像数据（Image）**：在机器人视觉中，摄像头采集的图像数据量很大，尤其是高分辨率、高帧率的图像。例如，一个1280x720的RGB图像每帧大约2.76MB（1280*720*3），如果以30Hz发布，那么带宽需求约为2.76MB * 30 = 82.8MB/s。
2. **点云数据（PointCloud）**：来自**激光雷达或深度相机**的点云数据，每个点通常包含xyz坐标和强度等信息，一帧点云可能包含数万到数十万个点，数据量也很大。例如，一个10万个点的点云，每个点有4个float（xyz和强度），一帧数据约为10万*4*4字节=1.6MB，如果以10Hz发布，带宽需求为16MB/s。
3. **激光扫描数据（LaserScan）**：虽然比点云数据量小，但高分辨率的激光雷达也会产生大量的数据。
4. **深度图像（Depth Image）**：与RGB图像类似，深度图像每个像素通常是一个16位整数，表示深度值，数据量也很大。
5. **视频流（Video）**：有些应用可能会直接传输视频流，例如H.264编码的视频，但即使编码后，数据量仍然可观。
6. **大规模传感器数据融合**：例如，多个传感器（如IMU、GPS、摄像头、激光雷达）的数据同时传输，尤其是高频IMU数据，虽然单条数据小，但频率高，累积起来也不小。
7. **地图数据（Map）**：特别是在SLAM中，地图数据可能很大，尤其是高分辨率的地图。
8. **机器人模型（URDF）**：虽然不常变化，但有时也会通过topic传输，特别是当模型很大时。
9. **批量传感器数据**：例如，从多个传感器节点批量发送的数据，用于记录或后期处理。

如何解决？

- **数据压缩**：例如，图像可以使用压缩格式（如JPEG）或者使用ROS2的图像压缩库。
- **降低发布频率**：如果不是需要每帧都处理，可以降低发布频率。
- **使用更高效的数据格式**：例如，对于点云，可以使用PointCloud2格式，它比传统的PointCloud1更高效。
- **使用ROS2的零拷贝传输**：在同一个节点内或者使用共享内存传输，避免数据复制。
- **使用DDS的可靠性和持久性设置**：根据数据的重要性调整QoS策略。



### 8. 应用层注册一个回调函数，从发布到订阅，再触发回调，处理业务，整个流程ROS2 库底层是怎样实现的？



### 9. service 底层是怎么调用的？





### 会关心机器人的物理属性吗？是怎么确定的？

深层需求可能是想了解URDF各个部分怎么对应到实际仿真中的表现，比如为什么机器人能站稳，关节怎么动起来。

惯性参数、碰撞属性、传动装置

**核心思想：** URDF 定义了机器人的**物理结构**和**外观**，而为了在 Gazebo 中进行真实的物理仿真，我们需要在 URDF 中添加 Gazebo 特定的标签和插件，来定义机器人的**物理属性**和**行为**。



基础 URDF 没有质量、惯性等概念。为了让 Gazebo 进行物理仿真，必须在 URDF 中为每个 **`<link>`** 添加 Gazebo 所需的物理属性。

- **`<inertial>`（惯性）：** 这是**最关键**的部分之一，位于 `<link>` 内。没有它，机器人在 Gazebo 中会像纸片一样飘走或行为异常。
  - **`<mass>`：** 连杆的质量（单位：千克）。
  - **`<inertia>`：** 惯性张量，描述质量分布，决定了物体旋转的难易程度。这个值通常需要通过 CAD 软件计算或进行合理估算。一个常见的近似是使用均匀几何体的惯性公式。

```xml
<link name="left_wheel">
  <visual> ... </visual>
  <collision> ... </collision>
  <!-- Gazebo 物理属性 -->
  <inertial>
    <mass value="2.0"/> <!-- 2公斤 -->
    <inertia ixx="0.01" ixy="0.0" ixz="0.0" iyy="0.01" iyz="0.0" izz="0.02"/>
  </inertial>
</link>
```

- **Gazebo 标签：** 在 URDF 中，使用 `<gazebo>` 标签来引用一个 `<link>` 或 `<joint>`，并为其添加更多 Gazebo 专属属性。
  - **`<material>`：** Gazebo 的材质，比 URDF 的更真实（例如，可以定义纹理）。
  - **`<mu1>`, `<mu2>`：** 摩擦系数。
  - **`<kp>`, `<kd>`：** 接触模型的刚度与阻尼。



#### 总结：确定机器人属性的完整流程

1. **设计机器人结构：** 确定有哪些连杆(link)和关节(joint)，它们的几何关系是怎样的。
2. **编写基础 URDF：** 使用 `<link>` 和 `<joint>` 描述机器人的运动学树。
3. **添加物理属性：** 为每个 `<link>` 添加 `<inertial>` 属性，并可通过 `<gazebo>` 标签调整摩擦系数等。
4. **集成传感器与执行器：** 使用 `<gazebo>` 标签和对应的插件，为机器人添加“感官”（摄像头、激光雷达）和“肌肉”（关节控制器）。
5. **在 Gazebo 中测试与迭代：**
   - 启动 Gazebo，加载你的 URDF 模型。
   - 观察机器人的物理行为是否正常（是否下坠？碰撞是否合理？）。
   - 测试传感器数据是否正常发布（例如，用 `rqt_image_view` 查看摄像头图像）。
   - 测试控制接口是否正常工作（例如，用 `rostopic pub` 发布速度命令看机器人是否移动）。







































