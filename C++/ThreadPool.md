<!--
 * @Author: JohnJeep
 * @Date: 2021-08-03 14:58:43
 * @LastEditTime: 2021-08-09 00:27:39
 * @LastEditors: Windows10
 * @Description: 线程池工作原理
-->

维基百科解释线程

--------------------------------------------------------------
线程池（英语：thread pool）：一种线程使用模式。线程过多会带来调度开销，进而影响缓存局部性和整体性能。而线程池维护着多个线程，等待着监督管理者分配可并发执行的任务。这避免了在处理短时间任务时创建与销毁线程的代价。线程池不仅能够保证内核的充分利用，还能防止过分调度。可用线程数量应该取决于可用的并发处理器、处理器内核、内存、网络sockets等的数量。 例如，线程数一般取cpu数量+2比较合适，线程数过多会导致额外的线程切换开销。

任务调度以执行线程的常见方法是使用同步队列，称作任务队列。池中的线程等待队列中的任务，并把执行完的任务放入完成队列中。

线程池模式一般分为两种：HS/HA半同步/半异步模式、L/F领导者与跟随者模式。

- 半同步/半异步模式又称为生产者消费者模式，是比较常见的实现方式，比较简单。分为同步层、队列层、异步层三层。同步层的主线程处理工作任务并存入工作队列，工作线程从工作队列取出任务进行处理，如果工作队列为空，则取不到任务的工作线程进入挂起状态。由于线程间有数据通信，因此不适于大数据量交换的场合。
- 领导者跟随者模式，在线程池中的线程可处在3种状态之一：领导者leader、追随者follower或工作者processor。任何时刻线程池只有一个领导者线程。事件到达时，领导者线程负责消息分离，并从处于追随者线程中选出一个来当继任领导者，然后将自身设置为工作者状态去处置该事件。处理完毕后工作者线程将自身的状态置为追随者。这一模式实现复杂，但避免了线程间交换任务数据，提高了CPU cache相似性。在ACE(Adaptive Communication Environment)中，提供了领导者跟随者模式实现。

--------------------------------------------------------------

线程池的伸缩性对性能有较大的影响。
- 创建太多线程，将会浪费一定的资源，有些线程未被充分使用。
- 销毁太多线程，将导致之后浪费时间再次创建它们。
- 创建线程太慢，将会导致长时间的等待，性能变差。
- 销毁线程太慢，导致其它线程资源饥饿。

--------------------------------------------------------------

组成部分
- 任务队列：存储需要处理的任务，由工作的线程来处理这些任务。
  - 通过线程池提供的 API 函数，将待处理的任务添加到任务队列，或者从任务队列中删除。
  - 将已处理的任务从任务队列中删除。
  - 线程池的使用者，也就是调用线程池函数往任务队列中添加任务的线程就是生产者线程。

- 工作线程：任务队列任务的消费者，N个。
  - 线程池中维护了一定数量的工作线程，他们的作用是不停的读任务队列，从任务队列里取出任务并处理。
  - 工作线程相当于是任务队列里的消费者角色。
  - 如果任务队列为空，工作的线程将会被阻塞 (使用条件变量 / 信号量阻塞)。
  - 如果阻塞之后有了新的任务，由生产者将阻塞解除，工作线程开始工作。

- 管理者线程：不处理任务队列中的任务，1个。
  - 它的任务是周期性的对任务队列中的任务数量以及处于忙状态的工作线程个数进行检测。
  - 当任务过多的时候，可以适当的创建一些新的工作线程。
  - 当任务过少的时候，可以适当的销毁一些工作的线程，减少资源的消耗。


线程池的简单模型

<img src="./figures/Thread_pool.svg">

<img src="./figures/schedulerTaskPool.gif">

--------------------------------------------------------------

线程池属于 “生产者-消费者”模型中的部分内容。

线程池中的线程在操作资源时，需要加锁和解锁，同一时间内只有一个线程操作同一块资源。


线程池作用

- 当你想要最小化加载和销毁线程的时间以及你想要限制同时运行的并行 job 的数量时，线程池很有帮助的。例如，可以在线程池中处理耗时的事件，让 UI 响应更快。



# 参考
- [基于C++11实现线程池的工作原理](https://www.cnblogs.com/ailumiyana/p/10016965.html)


