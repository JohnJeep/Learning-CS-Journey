<!--
 * @Author: JohnJeep
 * @Date: 2024-10-10 15:31:51
 * @LastEditors: JohnJeep
 * @LastEditTime: 2025-11-20 11:54:38
 * @Description: NTP 用法
 * Copyright (c) 2025 by John Jeep, All Rights Reserved. 
-->

- [1. 简介](#1-简介)
- [2. 安装 `ntpd`](#2-安装-ntpd)
- [3. 配置 `ntpd`](#3-配置-ntpd)
- [4. 启动并启用 `ntpd`](#4-启动并启用-ntpd)
- [5. 检查同步状态](#5-检查同步状态)
- [6. 手动同步时间](#6-手动同步时间)
- [7. 常见问题排查](#7-常见问题排查)
- [8. 总结](#8-总结)
- [9. 示例](#9-示例)
- [10. 例子分析](#10-例子分析)


### 1. 简介

`ntpd` 是传统的时间同步守护进程，用于让系统的时间与远程 NTP（Network Time Protocol）服务器持续保持同步。它适合长期在线的服务器，能逐步调整系统时钟，保持时间的精准性。以下是 `ntpd` 的使用方法，包括安装、配置和监控。

### 2. 安装 `ntpd`

在大多数 Linux 发行版上，`ntpd` 都可以通过包管理器安装：

```
# Debian/Ubuntu
sudo apt update
sudo apt install ntp

# CentOS/RHEL
sudo yum install ntp

# Fedora
sudo dnf install ntp
```

### 3. 配置 `ntpd`

`ntpd` 的配置文件通常位于 `/etc/ntp.conf`。打开文件，指定 NTP 服务器来同步时间。可以添加公共 NTP 服务器或局域网内的 NTP 服务器。例如，添加阿里云的 NTP 服务器：

```
server ntp.aliyun.com iburst
```

常用的配置选项包括：

- **server**：指定 NTP 服务器地址。
- **iburst**：当服务器首次不可用时，它会快速请求，提升同步速度。
- **restrict**：用于控制访问权限和网络范围。

可以添加多个 NTP 服务器以提高同步稳定性。例如：

```
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst
server 2.pool.ntp.org iburst
server 3.pool.ntp.org iburst
```

### 4. 启动并启用 `ntpd`

完成配置后，启动 `ntpd` 服务，并将其设置为开机自启：

```
# 启动 ntpd 服务
sudo systemctl start ntp

# 设置开机自启
sudo systemctl enable ntp
```

### 5. 检查同步状态

- **查看 NTP 服务器的同步状态**：

  ```bash
  ntpq -p
  ```

  输出会显示已连接的 NTP 服务器、延迟和偏差等信息。

- **查看系统时间的同步状态**：

  ```bash
  ntpstat
  ```

  此命令会告诉你系统时间是否与 NTP 服务器同步。

### 6. 手动同步时间

如果系统时间偏差较大，可以在启动 `ntpd` 之前使用 `ntpd` 的一次性命令手动同步。注意在执行以下命令时必须停止 `ntpd` 服务：

```shell
sudo systemctl stop ntp
sudo ntpd -gq
sudo systemctl start ntp
```

- `-g`：允许大幅度调整时间。
- `-q`：表示一次性查询时间并退出。

### 7. 常见问题排查

- **NTP 服务未同步**：检查防火墙设置是否允许 UDP 端口 123（NTP 使用的端口）。
- **时间漂移过大**：可以使用 `ntpd -gq` 强制一次性同步。

### 8. 总结

`ntpd` 适合长期在线的服务器，尤其适用于需要长时间稳定时间同步的环境。



### 9. 示例

在 `ntpq -p` 命令的输出中，各字段提供了 NTP 服务器和同步状态的详细信息。以下是这些字段的含义：

1. **remote**：远程 NTP 服务器的地址或主机名，表示当前同步的 NTP 源。
   - `*`：代表这是当前使用的主服务器（系统的同步源）。
   - `+`：代表备选服务器，即如果主服务器不可用，将选择此服务器。
   - `-`：该服务器已被排除，不参与时间同步。
   - `x`：代表该服务器有问题，不参与同步。
2. **refid**：远程服务器的参考 ID，即该服务器所使用的上游时间源。通常是 IP 地址或名称。
3. **st**（stratum）：层级，表示时间源的层级。值越小，表示时间源越靠近时钟源。常见值：
   - 0：表示服务器直接连接到原子钟或 GPS 时钟源。
   - 1：表示时间来自高精度设备（如 GPS）。
   - 2-15：表示服务器层级（层级越高，精度越低）。
4. **t**：远程服务器的类型。
   - `u`：unicast（单播），最常见的类型。
   - `m`：multicast（多播）。
   - `b`：broadcast（广播）。
5. **when**：上次从该服务器获取时间的时刻（以秒为单位），在下一次查询前不断递增。
6. **poll**：当前的查询间隔（以秒为单位），表示客户端每隔多长时间请求一次该服务器。值会在 64 到 1024 秒之间动态调整。
7. **reach**：到达计数器，显示客户端最近是否成功与服务器通信。reach 的值是一个 8 位二进制数（以八进制显示），每一位表示一次轮询的结果，成功为 `1`，失败为 `0`。例如 `377` 表示最近 8 次轮询全部成功（11111111）。
8. **delay**：网络延迟（以毫秒为单位），即客户端与服务器之间的往返时间。
9. **offset**：偏移量（以毫秒为单位），表示客户端时间与该服务器时间的差异。偏移值越小，同步越精确。
10. **jitter**：抖动，表示偏移量的变化情况，即最近几次轮询的偏移量波动程度，数值越小越好，说明时间源的稳定性越高。

### 10. 例子分析

```shell
remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*172.25.254.1    202.118.1.46     2 u    9 1024  377    3.652    1.614   6.546 
+172.25.254.2    202.118.1.46     2 u   91 1024  377    1.616    2.829   7.224
```

- **`172.25.254.1`** 是当前的同步源，因为前面带有 `*`。
- **`172.25.254.2`** 是备选同步源，因为前面带有 `+`。
- **st** 是 `2`，表示这是第二层的 NTP 服务器，比较常见。
- **delay** 和 **offset** 表明与服务器的网络延迟和时间偏移都在合理范围内。