<!--
 * @Author: JohnJeep
 * @Date: 2019-12-27 22:32:08
 * @LastEditTime: 2020-06-28 23:32:15
 * @LastEditors: Please set LastEditors
 * @Description: 网络数据相关协议学习
 * @FilePath: /ComputerNetwork/2.tcp-ip协议.md
--> 

<!-- TOC -->

- [0.1. 参考](#01-参考)
- [0.2. 基础概念](#02-基础概念)
- [0.3. 数据链路层](#03-数据链路层)
  - [0.3.1. 以太网帧格式](#031-以太网帧格式)
  - [0.3.2. PPP（点对点协议）](#032-ppp点对点协议)
  - [0.3.3. 环回接口（Loopback Interface）](#033-环回接口loopback-interface)
- [0.4. IP(网络层)](#04-ip网络层)
- [0.5. ARP地址解析协议](#05-arp地址解析协议)
- [0.6. RARP逆地址解析协议](#06-rarp逆地址解析协议)
- [0.7. ICMP(Internet控制报文协议)](#07-icmpinternet控制报文协议)
- [0.8. ping程序](#08-ping程序)
- [0.9. Traceroute程序](#09-traceroute程序)
- [0.10. TCP/IP](#010-tcpip)

<!-- /TOC -->

## 0.1. 参考
- [TCP/IP协议.卷一](https://www.kancloud.cn/lifei6671/tcp-ip/139758)

## 0.2. 基础概念
- OSI七层模型
  - 物理层(Physical Layer)
  - 数据链路层(Data Link Layer)
  - 网络层(Network Layer)
  - 传输层(Transport Layer)
  - 会话层(Session Layer)
  - 表示层(Presentation Layer)
  - 应用层(Application Layer)


- TCP/IP五层模型
  - 物理层(Physical Layer)
  - 数据链路层(Data Link Layer) : 处理与电缆接口的物理细节
  - 网络层(Network Layer)
    - 也称作互联网层，处理分组在网络中的活动。
    - ARP
    - IP
    - ICMP
  - 传输层(Transport Layer) ：为两台主机上的应用程序提供端到端的通讯。
    - TCP：把应用程序交给它的数据分成合适的小块交给下面的网络层，确认收到的分组，设置发送，最后确认分组的超时时间。TCP为两台主机提供可靠的数据通信。
    - UDP：只是把数据报的分组从一台主机发送到另一台主机，但并不保证该数据报能安全无误的抵达到另一端。
  - 应用层(Application Layer)
    - 负责处理特定的应用程序细节。 
    - 常见的通用应用程序
      - Telnet 远程登录。
      - FTP 文件传输协议。
      - SMTP 简单邮件传送协议。
      - SNMP 简单网络管理协议。

<img src="./figure/OSI七层模型.png">


- 最基本协议端口号
  - 以太网协议号
    - IP：0800
    - ARP：0806
    - PPPOE：8863、8864
    - IPV6：86DD
  - IP协议号
    - ICMP：1
    - TCP：6
    - UDP：17
    - GRE：47
    - ESP：50
    - AH：51
  - 端口号
    - FTP：20、21
    - SSH：22
    - Telnet：23
    - SMTP：25
    - TACACS：49
    - HTTP：80
    - HTTPS：443
    - IKE：500
    - Radius：1645、1646、1812、1813
  - 端口号
    - TCP和UDP采用 `16bit` 的端口号来识别应用程序
    - 端口号用来标识互相通信的应用程序。
    - 服务器使用的是知名端口号。一般小于1024。
    - 客户端的端口号叫 `临时端口号`，范围在 `1024~5000`之间。


- 数据包进入网络中之前需要进行封装，封装过程是操作系统处理的，而不是用户处理的。
- 寻路：寻找下一个路由节点。
- TCP传输过程中，数据包只会寻找一次的传输路径，并将其记下，下次的传输会使用以保存的传输路径，因此传输数据比较稳定。而UDP在网路传输过程中，每次传输的路径都不一样，每次传输需要重新寻找路径，因此传输数据没有TCP稳定。
- 分组交换（也叫蓄积交换）：让连接到通信电路中的计算机，将要发送的数据包分成多个数据包，按照一定的顺序排列之后分别发送。
- 吞吐量：主机之间实际的传输速率，其单位与带宽相同，都是bps(Bits Per Second)。
- 网桥：是在链路层上对网络进行互连，网桥使得多个局域网（LAN）组合在一起。
- 路由器：是在网络层上对网络进行互连。
- 数据报：是指从发送方传输到接收方的一个信息单元。
- TCP报文段(TCP segment)：TCP传给IP的数据单元。



## 0.3. 数据链路层
- 数据链路层也称网络接口层，通常包括操作系统中的设备驱动程序和计算机中对应的网络接口卡。
- 作用
  - 为IP模块发送和接收IP数据报；
  - 为ARP模块发送ARP请求和接收ARP应答；
  - 为RARP发送RARP请求和接收RARP应答。 

 
### 0.3.1. 以太网帧格式
- 以太网和IEEE 802封装格式
  <img src="./figure/数据帧封装格式.png">
- 帧(Frame): 通过以太网传输的比特流。
  - 长度必须在 46～1500字节之间。 

- 网络数据包 
  
  <img src="./figure/网络数据包.png">

- 数据进入协议栈时的封装过程 <img src="./figure/数据进入协议栈时的封装过程.png">



### 0.3.2. PPP（点对点协议）
- 数据帧格式
  <img src="./figure/PPP数据帧格式.png">

- 主要内容
  - 在串行链路上封装IP数据报
  - 建立、配置及测试数据链路的链路控制协议(LCP： Link Control Protocol)。它允许通信双方进行协商，以确定不同的选项。
  - 针对不同网络层协议的网络控制协议(NCP： Network Control Protocol)。
- 优点
  - PPP支持在单根串行线路上运行多种协议，不只是IP协议；
  - 每一帧都有循环冗余检验； 
  - 通信双方可以进行 IP地址的动态协商(使用IP网络控制协议)；
  - 与CSLIP类似，对TCP和IP报文首部进行压缩； 
  - 链路控制协议可以对多个数据链路选项进行设置。


### 0.3.3. 环回接口（Loopback Interface）
  - 它允许运行在同一台主机上的客户程序和服务器程序通过 TCP / IP进行通信。 
  - A类网络号127就是为环回接口预留的。根据惯例，大多数系统把 IP地址 `127.0.0.1` 分配给这个接口，并命名为 `localhost`。一个传给环回接口的 IP数据报不能在任何网络上出现
  - 注意点
    - 传给环回地址（一般是127.0.0.1）的任何数据均作为 IP输入。   
    - 传给广播地址或多播地址的数据报复制一份传给环回接口，然后送到以太网上。
    - 任何传给主机IP地址的数据均送到环回接口。



## 0.4. IP(网络层)
- IP数据报(IP datagram): IP传给网络接口层的数据单元。
- `TTL` 字段的目的是防止数据报在选路时无休止地在网络中流动。每次经过一个路由器，其值减一。
- IP提供不可靠、无连接的数据报传送服务。
- IP首部为 `20个字节`，选项字节最大不超过 `40字节`
<img src="./figure/IP数据报格式及首部中的各字段.png">

- 五类通用的互联网地址
<img src="./figure/五类互联网地址.png">

- 各类IP地址的范围
  
  <img src="./figure/各类IP地址的范围.png">

- 特殊的IP地址
  - 主机号和网络号全为 0，为 `DHCP`

- IP在首部中存入一个长度为 `8bit` 的数值，称作 `协议域`。 
  - 1: ICMP协议
  - 2: IGMP协议
  - 6: TCP协议
  - 17: UDP协议

- 路由表中的每一项包含的信息
  - 目的IP地址。既可以是一个完整的主机地址，也可以是一个网络地址，由该表目中的标志字段来指定。
  - 下一站（下一跳）路由器的IP地址。
  - 标志位。一个标志指明目的 IP地址是网络地址还是主机地址，另一个标志指明下一站路由器是否为真正的下一站路由器，还是一个直接相连的接口。
  - 为数据报的传输指定一个网络接口。

- 网络传输过程中地址的变化
  - 源IP和目的IP地址通常情况下始终保持不变，除做NET地址映射转换以外。
  - 源MAC地址和目的MAC地址始终在变化，路由器每跳一次，数据链路层的MAC地址都会随之改变。


- 两个常见的命令
  - `ifconfig或ipconfig`
    - `ipconfig /all` 显示完整配置信息 
  - `netstat`
    - `netstat - r` 查看路由表
    - `netstat -an` 查看当前网络的连接会话




## 0.5. ARP地址解析协议
- 作用：获取下一跳（下一个路由）的MAC地址。 即为IP地址与其对应的硬件地址之间提供动态映射。
- 物理地址大小为 `6 byte(即48 bit)` 

- ARP的分组格式
  <img src="./figure/ARP的分组格式.png">
- 2字节以太网帧类型，对ARP请求或应答来说，该字段的值为 `0x0806`
- 操作字段的四种操作类型
  - ARP请求：值为1
  - ARP应答：值为 2
  - RARP请求：值为3
  - RARP应答：值为4


## 0.6. RARP逆地址解析协议
- 作用：通过MAC地址寻找对应的IP地址。
- 分组格式
  - RARP请求或应答的帧类型代码为 `0x8035`，而且RARP请求的操作代码为 `3`，应答操作代码为 `4`
  - RARP请求以广播方式传送，应答以单播方式传送。
  
  

## 0.7. ICMP(Internet控制报文协议)
- ICMP封装在IP数据报内部的结构
  
  <img src="./figure/ICMP封装在IP数据报内部.png">

- ICMP报文格式
<img src="./figure/ICMP.png">

- ICMP地址掩码请求与应答
  - 数据报格式
    <img src="./figure/ICMP地址掩码请求和应答报文.png">
  - ICMP地址掩码 `应答` 必须是收到请求接口的子网掩码。

- ICMP时间戳请求与应答
  - ICMP时间戳请求允许系统向另一个系统查询当前的时间。 
  - 时间戳请求与应答数据报格式
  <img src="./figure/ICMP时间戳请求和应答报文.png">



## 0.8. ping程序
- 该程序发送一份回显请求报文给主机，并等待返回ICMP回显应答。


## 0.9. Traceroute程序
- 操作过程
  > 开始时发送一个TTL字段为 1的UDP数据报，然后将TTL字段每次加 1，以确定路径中的每个路由器。每个路由器在丢弃 UDP数据报时都返回一个 ICMP超时报文 2，而最终目的主机则产生一个ICMP端口不可达的报文。
- IP路由是动态的：每个路由器都要判断数据报将转发到哪个路由器。应用程序对此不进行控制，而且通常也并不关心路由。
- IP源站选路选项
- 发送端指明 I P数据报所必须采用的确切路由。
- 发送端指明了一个数据报经过的 I P地址清单，但是数据报在清单上指明的任意两个地址之间可以通过其他路由器。
- IP首部源站路由选项的通用格式
<img src="./figure/IP首部源站路由选项的通用格式.png">




## 0.10. TCP/IP 
- UDP数据报：UDP传给IP的信息单元称作(UDP datagram)，而且UDP的首部长为8字节。



NAT映射
- 作用对象
  - 公网---私网
  - 私网---公网


打洞机制
- 作用对象
  - 私网---私网

- 套接字（socket）
  - 网络中成对出现
  - 一个文件描述符指向两个内核缓冲区（一个读、一个写）
  - 指定IP和端口号

网络数据流采用的是大端法存储数据。


- `inet_pton()` 将点分十进制的IP地址转化为网络字节序
- `inet_ntop()` 将网络字节序转化为点分十进制的IP地址
- `inet_htonl()` 将点分十进制以字符串类型的IP地址转化为网络字节序