### rosbag2

**rosbag2** 是 ROS2 系统中的官方数据记录和回放工具。默认使用 **SQLite3** 数据库（`.db3` 文件），但也支持其他格式（如 MCAP）。将数据以发布订阅的方式发布到 指定的 topic。



### 核心功能

- **录制**：监听一个或多个指定的 ROS 2  Topic，并将发布到这些 Topic 上的所有消息序列化后写入磁盘文件。
- **回放**：读取之前录制的文件，并按照时间顺序将消息重新发布到对应的话题上，模拟出数据当初产生的场景。
- **信息查询**：查看录制文件的内容，例如包含了哪些话题、消息类型、录制时长等信息。



### 为什么 rosbag2 如此重要？

1.  **调试与诊断**：
    *   当机器人在真实环境中出现异常行为时，你很难在现场实时调试。使用 rosbag2 记录下问题发生时的所有传感器数据（如摄像头图像、激光雷达、IMU数据）和控制指令，然后回到实验室进行离线、反复的分析和重现，极大地提高了调试效率。

2.  **算法开发与测试**：
    *   你可以在真实环境中记录一次数据，然后多次回放，用于开发和测试新的感知、定位或规划算法。这避免了每次测试都需要在真实环境中部署机器人的麻烦，节省了大量时间和资源。

3.  **系统重现与验证**：
    *   通过回放一份标准的数据集，可以在不同的代码版本或参数配置下，精确地重现系统的行为，从而进行性能对比和回归测试。

4.  **数据共享与协作**：
    *   记录的数据包（通常称为 “bag 文件”）可以方便地在团队成员之间共享，为他人提供测试数据集，或者用于制作公开数据集。

---

### rosbag2 的关键特性

rosbag2 是 ROS1 rosbag 的继承者，它针对 ROS2 的架构进行了重新设计，具有以下关键特性和改进：

| 特性            | ROS1 rosbag            | ROS2 rosbag2                                                 | 优势                                                         |
| :-------------- | :--------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **存储后端**    | 自定义的 **.bag** 格式 | **插件化** 的后端。默认使用 **SQLite3** 数据库（`.db3` 文件） | **可扩展性**：可以插件形式支持其他数据库（如 MongoDB、PostgreSQL）。**可靠性**：SQLite 是事务性的，即使录制被意外中断，已记录的数据也不会损坏。 |
| **录制控制**    | 主要通过命令行参数     | **服务** 与 **动作**                                         | **动态控制**：可以在录制过程中通过 ROS2 服务 (`/rosbag2_recorder/pause`, `/resume` 等) 或动作来动态暂停、恢复或触发分段录制，而无需终止进程。 |
| **数据格式**    | 单一文件               | 支持 **元数据文件** 和 **数据文件分离**                      | **灵活性**：默认后端将数据存储在 `.db3` 文件中，同时有一个同名的 `.yaml` 文件存储元数据（如话题列表、类型等）。这便于管理和理解数据内容。 |
| **与 DDS 集成** | 紧耦合                 | 利用 ROS2 的 **中间件抽象层**                                | **兼容性**：能够更好地与不同的 DDS 实现（如 Fast DDS, Cyclone DDS）协同工作。 |

---

### 使用方法

rosbag2 主要通过命令行工具 `ros2 bag` 来操作。

#### 1. 记录数据

**记录指定话题：**
```bash
# 语法：ros2 bag record <topic1> <topic2> ...
ros2 bag record /camera/image_raw /scan /odom
```
这会将这三个话题的数据记录到当前目录下一个以时间戳命名的新文件夹中。

**记录所有话题：**

```bash
ros2 bag record -a
```
（谨慎使用，因为数据量可能非常大）。

**指定记录文件名：**
```bash
ros2 bag record -o my_test_run /camera/image_raw
```
数据将保存在名为 `my_test_run` 的目录中。

#### 2. 查看记录的信息

**列出记录文件的内容：**

```bash
# 语法：ros2 bag info <bag_directory>
ros2 bag info my_test_run

# 输出示例：
Files:             my_test_run.db3
Bag size:          8.5 MiB
Storage id:        sqlite3
Duration:          45.2s
Start:             Nov 1 2024 10:30:15.123
End:               Nov 1 2024 10:30:60.345
Messages:          1350
Topic information: Topic: /camera/image_raw | Type: sensor_msgs/msg/Image | Count: 900 | Serialization Format: cdr
                   Topic: /scan | Type: sensor_msgs/msg/LaserScan | Count: 450 | Serialization Format: cdr
```

#### 3. 回放数据

**基本回放：**
```bash
# 语法：ros2 bag play <bag_directory>
ros2 bag play my_test_run
```
这会开始将记录的话题数据重新发布到系统中，就像这些数据来自真实的传感器一样。

**控制回放：**
```bash
# 以2倍速回放
ros2 bag play my_test_run -r 2

# 从第10秒开始回放
ros2 bag play my_test_run --start-offset 10

# 只回放特定话题
ros2 bag play my_test_run --topics /scan
```

---

### 总结

**rosbag2** 是 ROS2 生态中一个不可或缺的工具，它提供了强大、灵活且可靠的数据记录和回放能力。其基于插件和服务的现代化设计，使其比 ROS1 的 rosbag 更加强大，更适合于复杂的、生产级的机器人应用开发和调试。无论是对于初学者还是资深机器人工程师，熟练掌握 rosbag2 都是必备技能。