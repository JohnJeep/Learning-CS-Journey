**Node Composition（节点组合）** 是一种将多个节点（Nodes）运行在同一个进程中的技术，旨在**提升节点间通信的性能和效率**。

---

### 为什么需要 Node Composition？

要理解它的好处，我们首先要看看默认的、非组合式的方式是如何工作的。

#### 1. 默认方式：独立进程（非组合）

在默认情况下，每个 ROS2 节点都是一个独立的操作系统进程。

*   **通信机制**：当一个节点（发布者）想要向另一个节点（订阅者）发送消息时，它们通过 **DDS（数据分发服务）中间件** 进行通信。这意味着数据需要经过以下流程：

    ```
    发布者节点进程 → DDS库 → 操作系统内核 → 网络/共享内存 → 操作系统内核 → DDS库 → 订阅者节点进程
    ```

*   **优点**：

    *   **隔离性好**：一个节点崩溃不会影响其他节点。
    *   **开发简单**：每个节点可以独立开发、编译和启动。

*   **缺点**：
    *   **性能开销大**：数据需要经过进程间通信和完整的 DDS 序列化/反序列化，引入了显著的延迟和 CPU 开销。

这种开销在数据量大或对实时性要求高的场景（如机器人控制、传感器数据处理）中是不可接受的。

#### 2. 组合方式：单进程内协作

通过 Node Composition，你可以将多个有通信关系的节点编译成一个**共享库**，然后在一个主进程中动态加载和运行它们。

*   **通信机制**：当组合节点在同一个进程内通信时，它们可以直接进行**函数调用**。
    `发布者组件` -> **函数调用** -> `订阅者组件`
*   **优点**：
    *   **极低的延迟**：避免了进程间切换和 DDS 的开销，通信延迟大幅降低。
    *   **高吞吐量**：数据可以直接在内存中传递，无需序列化/反序列化。
    *   **资源占用少**：减少了对操作系统资源的占用（如 PID、内存页）。
*   **缺点**：
    *   **隔离性差**：如果一个节点出现严重错误（如段错误），会导致整个进程崩溃，所有组合在内的节点都会停止工作。
    *   **灵活性降低**：节点的启动和关闭是绑定在一起的。

---

### Node Composition 的三种实现方式

ROS2 提供了三种主要的方法来实现节点组合：

1.  **手动组合（Manual Composition）**
    *   **描述**：程序员编写一个 C++ 主函数，在函数中显式地创建所有节点并执行它们。
    *   **适用场景**：适用于节点数量和结构固定的简单应用。
    *   **特点**：最直接，但灵活性最差。

    ```cpp
    #include <rclcpp/rclcpp.hpp>
    #include <node1.hpp>
    #include <node2.hpp>
    
    int main(int argc, char* argv[]) {
      rclcpp::init(argc, argv);
      // 在同一个线程中创建并运行两个节点
      auto node1 = std::make_shared<Node1>();
      auto node2 = std::make_shared<Node2>();
      rclcpp::spin(node1);
      rclcpp::spin(node2);
      rclcpp::shutdown();
      return 0;
    }
    ```

2.  **使用 ComposableNode 容器**
    *   **描述**：这是最常用和推荐的方式。你将每个节点定义为一个 **`ComposableNode`** 类。然后，使用一个 **组件容器（Component Container）** 来加载这些节点。
    *   **实现**：在你的节点类中，使用 `rclcpp_components` 库的宏 `RCLCPP_COMPONENTS_REGISTER_NODE` 进行注册。
    *   **启动方式**：
        *   **命令行加载**：先启动一个通用的组件容器进程，然后通过命令行指令动态加载指定的节点库。
          ```bash
          # 终端1：启动容器
          ros2 run rclcpp_components component_container
          # 终端2：加载名为 my_package 中的组件节点 MyNode
          ros2 component load /ComponentManager my_package MyNode
          ```
        *   **启动文件加载**：在 Python 启动文件中描述加载逻辑，这是最实用和强大的方式。

3.  **进程内通信（Intra-Process Communication）**
    *   **注意**：这是一个相关但不同的概念。即使节点是独立的进程，只要它们由同一个启动文件启动，并且使用 **唯一名地址（Unique Network Flow Endpoints）**，ROS2 可以尝试在它们之间启用零拷贝的进程内通信。然而，最可靠、最高效地启用进程内通信的方式，仍然是使用 Node Composition。

---

### 如何选择？总结与对比

| 特性              | 独立进程（默认）                 | 节点组合                                                     |
| :---------------- | :------------------------------- | :----------------------------------------------------------- |
| **性能**          | 较低（进程间通信 + DDS）         | **极高**（函数调用，零拷贝）                                 |
| **资源占用**      | 较高                             | **较低**                                                     |
| **隔离性/可靠性** | **高**（一个节点崩溃不影响系统） | 低（一个节点崩溃导致整个容器崩溃）                           |
| **灵活性**        | **高**（可独立启停）             | 低（通常一起启停）                                           |
| **适用场景**      | 大部分常规应用，调试阶段         | **高性能计算**、**实时控制**、**资源受限设备**、紧密耦合的节点组 |

### 结论

**ROS2 Node Composition** 是一种通过牺牲部分隔离性和灵活性来换取极致通信性能的优化技术。它通过将多个节点合并到同一进程，使它们能够像普通的函数和对象一样直接、高效地交互。对于构建高性能、低延迟的机器人系统（如处理相机数据、控制电机等），它是至关重要的工具。在设计和开发 ROS2 系统时，应根据节点的功能、耦合度和性能要求，合理选择是否使用组合节点。